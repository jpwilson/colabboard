# Error Fix Log

Check this file before debugging. Add new entries after resolving issues.

Format: **Date | Error | Root Cause | Fix | Prevention**

---

### 2026-02-17 | Vercel env vars have trailing `\n` → WebSocket 401

**Error:** Supabase Realtime WebSocket connections return 401 Unauthorized on deployed Vercel app. Works locally.

**Root Cause:** All Vercel environment variables had a trailing newline character (`\n`) appended to their values. The Supabase REST API tolerated this, but the WebSocket endpoint rejected `apikey=eyJ...csOw\n` as invalid.

**Fix:** Removed all env vars from Vercel and re-added them using `printf` (not `echo`) to avoid trailing newlines:
```bash
printf 'value_here' | npx vercel env add VAR_NAME production
```

**Prevention:** Always use `printf` when piping values to `vercel env add`. Never use `echo` which appends `\n`.

---

### 2026-02-17 | Supabase Realtime requires JWT anon key, not publishable key

**Error:** WebSocket connections to Supabase Realtime fail with 401 when using the modern publishable key (`sb_publishable_...`).

**Root Cause:** Supabase Realtime only accepts the legacy JWT anon key (`eyJ...`) for WebSocket authentication. The newer publishable key format works for REST API but not for Realtime.

**Fix:** Switched `client.ts`, `server.ts`, and `proxy.ts` from `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` to `NEXT_PUBLIC_SUPABASE_ANON_KEY`. Added the JWT key to `.env.local` and Vercel.

**Prevention:** Always use `NEXT_PUBLIC_SUPABASE_ANON_KEY` (JWT format) for any Supabase client that needs Realtime.

---

### 2026-02-16 | `vi.mock()` fails with `@/` alias paths

**Error:** Vitest mocks using `vi.mock('@/lib/supabase/client')` don't intercept the actual module.

**Root Cause:** Vitest's module resolution for `vi.mock()` doesn't reliably resolve TypeScript path aliases (`@/`).

**Fix:** Use relative paths: `vi.mock('../lib/supabase/client')`.

**Prevention:** Always use relative paths in `vi.mock()` calls.

---

### 2026-02-16 | Vitest needs Supabase env vars in config

**Error:** Tests crash even with mocked Supabase client — `createBrowserClient` throws "URL and Key required".

**Root Cause:** Module-level imports execute before `vi.mock()` takes effect. The real Supabase module loads and validates env vars.

**Fix:** Added dummy env vars to `vitest.config.mts`:
```ts
test: {
  env: {
    NEXT_PUBLIC_SUPABASE_URL: 'http://localhost:54321',
    NEXT_PUBLIC_SUPABASE_ANON_KEY: 'test-key',
  }
}
```

**Prevention:** Always provide test env vars in `vitest.config.mts` `test.env`.

---

### 2026-02-16 | `bg-primary` Tailwind class doesn't render

**Error:** Login submit button has no background color when using `bg-primary`.

**Root Cause:** Tailwind v4 CSS-first config with `@theme inline` custom properties may not generate `bg-primary` utility for all element types.

**Fix:** Use explicit color: `bg-[#0096FF]` or inline styles.

**Prevention:** Test Tailwind custom color utilities on actual elements. Fall back to explicit hex values if `bg-*` custom classes don't render.

---

### 2026-02-15 | Board slug insert requires empty string

**Error:** TypeScript error when inserting board without slug, or slug conflicts.

**Root Cause:** Board slugs are generated by a PostgreSQL trigger on insert. The trigger fires on INSERT and generates `adjective-noun-number` slugs. But the Supabase client requires the field to be present.

**Fix:** Insert with `slug: ''` and cast: `as Record<string, unknown>`.

**Prevention:** Always insert boards with `slug: ''` — the trigger handles generation.

---

### 2026-02-15 | Supabase functions need `SET search_path`

**Error:** Supabase security advisor warns about functions without explicit search path.

**Root Cause:** PostgreSQL functions default to searching all schemas, which is a security risk.

**Fix:** Add `SET search_path = public` to all function definitions.

**Prevention:** Always include `SET search_path = public` when creating Supabase functions.

---

### 2026-02-17 | E2E CI crashes without Supabase env vars

**Error:** GitHub Actions E2E job fails — Playwright times out waiting for dev server.

**Root Cause:** The E2E job starts a Next.js dev server which calls `createServerClient()`. Without `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY`, Supabase throws and the server crashes.

**Fix:** Added env vars to the E2E job in `.github/workflows/ci.yml`.

**Prevention:** Any CI job that starts the Next.js server needs Supabase env vars.

---

### 2026-02-14 | jsdom v24 required for Node 20.9.0

**Error:** jsdom v28 fails to install or throws ESM compatibility errors.

**Root Cause:** jsdom v28 requires Node 22+. Node 20.9.0 (used in CI and local) is incompatible.

**Fix:** Pin `jsdom` to v24 in `package.json`.

**Prevention:** Check Node version compatibility before upgrading jsdom.
